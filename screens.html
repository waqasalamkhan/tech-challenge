<html>
<head>


    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css">
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css" />
    <style>
        <!--

        body {
            font-family: Arial;
            font-size: 1.2em;
            background-color: lightblue;
        }

        textarea {
            width: 68%;
            height: 94vh;
            padding: 12px 20px;
            box-sizing: border-box;
            border: 2px solid #fffcfc;
            border-radius: 4px;
            background-color: #1c1b1b;
            color: white;
            font-size: 16px;
            resize: none;
            font-family: monospace;
        }

        .ActionButtons {
            display: inline-block;
            width: 100px;
            padding: 10px;
            box-sizing: border-box;
            vertical-align: top;
        }

            .ActionButtons .ActBtn {
                width: 100%;
                height: 52px;
                background: rgba(23, 172, 172, 1);
                color: white;
                border: 1px solid rgba(0, 0, 0, 0.53);
                cursor: pointer;
                margin: 5px auto;
            }

        canvas#terminalScreen {
            background: transparent;
        }

        .hiddenFileField {
            width: 0px;
            height: 0px;
            overflow: hidden;
        }

        .panelBtn {
            background: rgba(23, 153, 253, 0.72);
            color: white;
            padding: 5px;
            width: 153px;
            margin: 5px 10px;
            box-sizing: border-box;
        }

        .canvasContainer {
            position: relative;
            width: 640px;
            height: 420px;
            border: 1px solid rgba(0, 0, 0, 0.21);
            display: inline-block;
            vertical-align: top;
            background-size: 100% 100%;
            background-color: white;
        }

            .canvasContainer.drawing {
                cursor: crosshair;
            }

        .btn_Draw.active {
            background: green;
            border: 1px solid black;
        }

        .CodePanel {
            float: left;
        }

        .drawingButtonsPanel,
        .drawingArea,
        .atmScreens {
            width: 952px;
            /*margin: 5px auto;*/
            background-color: #6f7f8d;
            float: right;
            border: 1px dashed rgba(255, 255, 255, 0.6);
            text-align: center;
            position: relative;
            z-index: 999;
        }


        .atmButtons,
        .canvasContainer {
            display: inline-block;
            vertical-align: top;
            /*height: 480px;*/
        }

        .atmButtons {
            display: inline-block;
            width: 100px;
            padding: 10px;
            box-sizing: border-box;
            padding-top: 210px;
        }

            .atmButtons .atmBtn {
                width: 100%;
                height: 52px;
                background: rgba(23, 172, 172, 1);
                color: white;
                border: 1px solid rgba(0, 0, 0, 0.53);
                cursor: pointer;
                margin: 5px auto;
            }

                .atmButtons .atmBtn .action {
                    font-size: 10px;
                    font-weight: bold;
                }

                .atmButtons .atmBtn.btnProgrammed {
                    background: rgba(23, 153, 253, 1);
                }

        .atmScreen {
            width: 110px;
            height: 83px;
            margin: 5px;
            background-size: 100% 100%;
            display: inline-block;
            border: 3px solid rgba(251 251 251 / 74%);
            cursor: pointer;
            vertical-align: top;
            box-sizing: border-box;
            z-index: 999;
            line-height: 83px;
            color: #fff;
        }

            .atmScreen.addNew {
                border-style: dashed;
                text-align: center;
                padding-top: 20px;
                color: rgba(255 255 255 / 68%);
            }

            .atmScreen.active {
                border-color: green;
            }

        .genericContextMenu {
            position: absolute;
            width: 152px;
            border: 1px solid rgba(0, 0, 0, 0.16);
            background: rgba(240, 240, 240, 1);
            cursor: pointer;
            top: 23px;
            font-size: 13px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.023);
            box-sizing: border-box;
            padding: 3px;
            text-align: left;
            line-height: 15px;
            display: none;
        }

        .atmScreensContextMenu:hover {
            background: rgba(253, 240, 223, 1);
        }

        .atmButtonsContextMenu span:hover {
            background: rgba(40, 110, 253, 0.072);
        }

        .atmButtonsContextMenu {
            padding: 1px;
            background-color: white;
        }


            .atmButtonsContextMenu span {
                display: block;
                padding: 5px;
                box-sizing: border-box;
            }

        .ActiveImg {
            border: 1px solid red;
        }

        .imgThumbnail {
            width: 100px;
            z-index: -999;
        }
    </style>

</head>
<body>
    <input type="text" hidden name="" id="ImgID">
    <input type="text" hidden name="" id="ImgSrc">
    <div class="CodePanel">
        <div class="ActionButtons buttonsLeft">
            <button class="ActBtn btnLeft" btnid="b1" id="AddCursorBtn">Cursor Point <br /></button>
            <button class="ActBtn btnLeft" btnid="b2" id="AddTextBtn">Text<br /></button>
            <button class="ActBtn btnLeft" btnid="b3" id="ClearScreenBtn">Clear Screen<br /></button>
            <button class="ActBtn btnLeft" btnid="b4" id="AddImageBtn">Add Image<br /></button>
        </div>
        <textarea id="CodeField" name="CodeField"></textarea>
    </div>
    <div class="drawingButtonsPanel">
        <div class="hiddenFileField">
            <input type="file" id="UploadFile" accept="image/png, image/jpeg, image/gif" onchange="onChange_UploadFile()" />
        </div>
        <input type="button" class="panelBtn btn_Upload" value="Generate File" />
        <input type="button" class="panelBtn btn_ToggleGrid" onclick="onclick_ToggleGrid()" value="Show Grid" />
    </div>
    <div class="drawingArea">
        <div class="atmButtonsContextMenu genericContextMenu">
            <span class="btnAction" uid="actionNext" lbl="Next Screen">&#187; Next Screen</span>
            <span class="btnAction" uid="actionPrevious" lbl="Previous Screen">&#171; Previous Screen</span>
            <span class="btnAction" uid="actionSpecfic" lbl="Specific Screen">&#9856; Specific Screen</span>
            <span class="btnAction" uid="actionUnassign" lbl="N/A">&#128473; No Action</span>
        </div>
        <div class="atmButtons buttonsLeft">
            <button class="atmBtn btnLeft" btnid="b1">Button 1 <br /><span class="action">Action:<span class="actionName">N/A</span></span></button>
            <button class="atmBtn btnLeft" btnid="b2">Button 2 <br /><span class="action">Action:<span class="actionName">N/A</span></span></button>
            <button class="atmBtn btnLeft" btnid="b3">Button 3 <br /><span class="action">Action:<span class="actionName">N/A</span></span></button>
            <button class="atmBtn btnLeft" btnid="b4">Button 4 <br /><span class="action">Action:<span class="actionName">N/A</span></span></button>
        </div>
        <div class="canvasContainer">
            <div>
                <div></div>
            </div>
            <canvas id="canvas"></canvas>
        </div>
        <div class="atmButtons buttonsRight">
            <button class="atmBtn btnRight" btnid="b5">Button 5 <br /><span class="action">Action:<span class="actionName">N/A</span></span></button>
            <button class="atmBtn btnRight" btnid="b6">Button 6 <br /><span class="action">Action:<span class="actionName">N/A</span></span></button>
            <button class="atmBtn btnRight" btnid="b7">Button 7 <br /><span class="action">Action:<span class="actionName">N/A</span></span></button>
            <button class="atmBtn btnRight" btnid="b8">Button 8 <br /><span class="action">Action:<span class="actionName">N/A</span></span></button>
        </div>
    </div>
    <div class="atmScreens">
        <div class="atmScreensContextMenu genericContextMenu" onclick="onClick_RemoveScreen()">
            &#10005; Remove this screen
        </div>
        <div class="atmScreen editableScreen active" title="Active Screen" uid="">
            <img class="imgThumbnail">
        </div>
        <div class="atmScreen addNew" onclick="onClick_AddNewScreen(event)" title="Add New Screen">Add New Screen</div>
    </div>

    <div class="modal fade" tabindex="-1" role="dialog" id="CursorModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Add Cursor Point</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="CursorRow">Rows</label>
                        <select class="form-control" id="CursorRow" w>
                            <option>@</option>
                            <option>A</option>
                            <option>B</option>
                            <option>C</option>
                            <option>D</option>
                            <option>E</option>
                            <option>F</option>
                            <option>G</option>
                            <option>H</option>
                            <option>I</option>
                            <option>J</option>
                            <option>K</option>
                            <option>L</option>
                            <option>M</option>
                            <option>N</option>
                            <option>O</option>
                        </select>
                        <br>
                        <label for="CursorColumn">Columns</label>
                        <select class="form-control" id="CursorColumn">
                            <option>@</option>
                            <option>A</option>
                            <option>B</option>
                            <option>C</option>
                            <option>D</option>
                            <option>E</option>
                            <option>F</option>
                            <option>G</option>
                            <option>H</option>
                            <option>I</option>
                            <option>J</option>
                            <option>K</option>
                            <option>L</option>
                            <option>M</option>
                            <option>N</option>
                            <option>O</option>
                            <option>0</option>
                            <option>1</option>
                            <option>2</option>
                            <option>3</option>
                            <option>4</option>
                            <option>5</option>
                            <option>6</option>
                            <option>7</option>
                            <option>8</option>
                            <option>9</option>
                            <option>:</option>
                            <option>;</option>
                            <option><</option>
                            <option>=</option>
                            <option>></option>
                            <option>?</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="onAddCursorPoint()">Add</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" tabindex="-1" role="dialog" id="TextModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Add Text</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="TextField">Text</label>
                        <input type="text" class="form-control" id="TextField" placeholder="Enter Text">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="onAddText()">Add</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <div class="modal fade" tabindex="-1" role="dialog" id="ImagesModal">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Select Image</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <div class="imageSliderWrapper">
                            <div class="owl-carousel owl-theme">

                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="onAddImageText()">Add</button>
                </div>
            </div><!-- /.modal-content -->
        </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/ui/1.13.1/jquery-ui.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <script type="text/javascript">
        //Taha

        var canvas = document.getElementById("canvas");
        var ctx = canvas.getContext("2d");
        canvas.width = 640;
        //canvas.height = 320;
        canvas.height = 420;
        var cellSizeWidth = 20;
        var cellSizeHeight = 26;
        var grid = [];
        var centerPoints = [];
        var ImageArray;
        class Cell {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.z = 0;
                this.width = cellSizeWidth;
                this.height = cellSizeHeight;
                this.c = "#d7d8d9";
                this.center = { x: this.x + this.width / 2 - canvas.width / 2, y: (this.y + this.height / 2 - canvas.height / 2) + 1 };
            }
            draw() {
                ctx.strokeStyle = this.c;
                ctx.lineWidth = 0.5;
                ctx.strokeRect(this.x, this.y, this.width, this.height);
            }
            createArray() {
                centerPoints.push({ 'x': this.center.x, 'y': this.z, 'z': this.center.y })
            }
        }

        function createGrid() {
            for (var y = 0; y < canvas.height; y += cellSizeHeight) {
                for (var x = 0; x < canvas.width; x += cellSizeWidth) {
                    grid.push(new Cell(x, y));
                }
            }
        }
        createGrid();

        function drawGrid() {
            for (var i = 0; i < grid.length; i++) {
                grid[i].draw();
                grid[i].createArray();
            }
        }
        drawGrid();

        var ScreenID = 0;
        function reOffset() {
            var BB = canvas.getBoundingClientRect();
            offsetX = BB.left;
            offsetY = BB.top;
        }
        var offsetX, offsetY;
        reOffset();
        window.onscroll = function (e) { reOffset(); }
        window.onresize = function (e) { reOffset(); }

        var isDown = false;
        var startX, startY;

        var atmScreens = [];

        var rects = [];
        var newRect;
        var atmBtnID = "";

        var DummyObj = [];
        var tempObj = {};

        $("#terminalScreen").mousedown(function (e) { handleMouseDown(e); });
        $("#terminalScreen").mousemove(function (e) { handleMouseMove(e); });
        $("#terminalScreen").mouseup(function (e) { handleMouseUp(e); });
        $("#terminalScreen").mouseout(function (e) { handleMouseOut(e); });

        function drawAll() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 1;
            ctx.fillStyle = "rgba(10, 253, 153, 0.21)";
            ctx.strokeStyle = 'green';
            if (atmScreens[activeScreenUID].rect) {
                var r = atmScreens[activeScreenUID].rect;
                ctx.strokeRect(r.left, r.top, r.right - r.left, r.bottom - r.top);
                ctx.fillRect(r.left, r.top, r.right - r.left, r.bottom - r.top);
            }

            var btns = atmScreens[activeScreenUID].buttons;
            for (var i = 1; i < 9; i++) {
                $(".atmBtn[btnid='b" + i + "']").find(".actionName").html(btns["b" + i]);
                $(".atmBtn[btnid='b" + i + "']").removeClass("btnProgrammed");
                if (btns["b" + i] != "N/A") {
                    $(".atmBtn[btnid='b" + i + "']").addClass("btnProgrammed");
                }
            }
        }

        function willOverlap(newRect) {

            // shortcut to the new potential rect
            var r2 = newRect;

            // test if one rect is completely inside another rect
            var isInside = function (rect1, rect2) {
                return (rect2.left >= rect1.left &&
                    rect2.right <= rect1.right &&
                    rect2.top >= rect1.top &&
                    rect2.bottom <= rect1.bottom);
            }

            // test if the new rect is overlapping any existing rect
            var isOverlapping = false;
            for (var i = 0; i < rects.length; i++) {
                var r1 = rects[i];
                //
                var isIntersecting = !(r2.left > r1.right ||
                    r2.right < r1.left ||
                    r2.top > r1.bottom ||
                    r2.bottom < r1.top);
                //
                var isContained = isInside(r1, r2) || isInside(r2, r1);
                //
                if (isIntersecting || isContained) {
                    isOverlapping = true;
                }
            }
            return (isOverlapping);
        }

        function onclick_ToggleGrid() {
            if ($(".btn_ToggleGrid").val() == "Show Grid") {
                drawGrid();
                $(".btn_ToggleGrid").val("Hide Grid");
            }
            else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                $(".btn_ToggleGrid").val("Show Grid");
            }
        }

        function onclick_AddBackground() {
            $("#UploadFile").trigger("click");
        }

        /*function onChange_UploadFile(event) {

            var file = document.getElementById("UploadFile").files[0];
            var validImageTypes = ["image/gif", "image/jpeg", "image/png"];
            if (file.size > 512000) {
                alert("File size should be less than 500KB");
                return;
            }
            if (validImageTypes.indexOf(file.type) < 0) {
                alert("File upload a valid image file (JPG/PNG/GIF)");
                return;
            }
            var getImagePath = URL.createObjectURL(file);
            atmScreens[activeScreenUID].url = getImagePath;
            atmScreens[activeScreenUID].filename = file.name;
            $('.canvasContainer, .atmScreen.active').css('background-image', 'url("' + getImagePath + '")');

        }*/

        /*function draw() {
            //var canvas = document.getElementById('terminalScreen');
            //var ctx = canvas.getContext('2d');
            //ctx.drawImage(this, 0, 0, 640, 480);
        }*/

        function failed() {
            console.log("failed");
        }

        function onClick_AddNewScreen(e) {

            var CodeFieldVal = "";
            atmScreens[activeScreenUID].code = $("#CodeField").val();

            const canvas_ID = document.getElementById("canvas");

            //const URL = canvas_ID.toDataURL();
            //if (atmScreens[activeScreenUID].isImageUploaded != "1") {
            //    atmScreens[activeScreenUID].url = URL;
            //}


            //var currentState = $(e.target).prev().find("img").attr('id');
            ////console.log(currentState);
            //const img_from_canvas = document.getElementById(currentState);
            //img_from_canvas.src = canvas_ID.toDataURL();

            var newScreenID = "atmSC" + new Date().getTime();
            activeScreenUID = newScreenID;

            $(e.target).before("<div class='atmScreen editableScreen'><img class='imgThumbnail' id=" + activeScreenUID + "></div>");

            atmScreens[activeScreenUID] = {
                url: "",
                rect: {},
                buttons: { "b1": "N/A", "b2": "N/A", "b3": "N/A", "b4": "N/A", "b5": "N/A", "b6": "N/A", "b7": "N/A", "b8": "N/A" },
                filename: "",
                code: ""
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGrid();


            $("#CodeField").val("").html("");
            $(e.target).prev().eq(0).attr("uid", newScreenID).trigger("click");
            //drawAll();
            ScreenID++;
            if (ScreenID == 1) {
                $("#CodeField").append("\n");
            }
            var Length = 3;
            ScreenID = ScreenID.toString();
            while (ScreenID.length < Length) ScreenID = "0" + ScreenID;
            CodeFieldVal += ScreenID;
            CodeFieldVal += "\n";
            $("#CodeField").val(CodeFieldVal);
        }

        $(function () {

            $(".atmScreens").sortable({
                items: "div:not(.addNew)"
            });
            $(".atmScreens").disableSelection();

            $(document).on("click", "#AddCursorBtn", function (e) {
                $('#CursorModal').modal('show');
            });

            $(document).on("click", "#AddTextBtn", function (e) {
                $('#TextModal').modal('show');
            });

            $(document).on("click", "#ClearScreenBtn", function (e) {
                var CodeFieldVal = $("#CodeField").val();
                CodeFieldVal += "\n";
                CodeFieldVal += "CLS";
                $("#CodeField").val(CodeFieldVal);

            });

            $(document).on("click", "#AddImageBtn", function (e) {
                $('#ImagesModal').modal('show');
            });

            $(document).on("click", ".atmScreen.editableScreen", function (e) {

                $("#CodeField").val("");

                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawGrid();

                $(".atmScreen.editableScreen").attr("title", "Click to edit this screen").removeClass("active");
                $(e.target).addClass("active").attr("title", "Active Screen");

                activeScreenUID = $(e.target).attr("uid");

                //for (key in atmScreens[activeScreenUID].code.split(",")) {
                //    if (atmScreens[activeScreenUID].code.split(",")[key].includes("SET")) {
                //        console.log(key);
                //        console.log(atmScreens[activeScreenUID].code.split(",")[key]);
                //    }
                //}

                Object.values(atmScreens[activeScreenUID].code.split(",")).forEach((value, index) => {

                    if ((value).includes("SET")) {

                        // Rendeing Image on Canvas
                        if (atmScreens[activeScreenUID].code.split(",")[index + 1].includes("P2")) {
                            var TempVar = atmScreens[activeScreenUID].code.split(",")[index + 1];

                            var str = atmScreens[activeScreenUID].code.split(",")[index];
                            var after = str.substring(str.indexOf(' ') + 1);
                            var Coordinates = after.split("");

                            var Xaxis = CoordinateMapX[Coordinates[0]];
                            var Y_Position = CoordinateMapX[Coordinates[0]];

                            Object.values(TempVar.split(" ")).forEach((value, index) => {
                                
                                if ((value).includes("P2")) {
                                    base_image = new Image();
                                    base_image.src = 'http://localhost/StatesMaster/img/screens/' + TempVar.split(" ")[index + 1] + '.jpg';
                                    base_image.onload = function () {
                                        ctx.drawImage(base_image, Xaxis, Y_Position);
                                    }
                                }

                            });

                        } else {

                            // Rendering Text on Canvas
                            var str = value.split(" ")[1];
                            var after = str.substring(str.indexOf(' ') + 1);
                            var Coordinates = after.split("");

                            var Xaxis = CoordinateMapX[Coordinates[0]];
                            var Y_Position = CoordinateMapX[Coordinates[0]];
                            var text = atmScreens[activeScreenUID].code.split(",")[index + 1]
                            var myArray = text.split("");

                            for (var i = 0; i < myArray.length; i++) {
                                ctx.font = "26px Arial";
                                ctx.fillText(myArray[i], Xaxis, Y_Position);
                                Xaxis = Xaxis + 20;
                            }
                        }

                    }
                    
                });

                for (var x = 0; x < atmScreens[activeScreenUID].code.split(",").length; x++) {
                    //onAddText
                    var CodeFieldVal = $("#CodeField").val();
                    CodeFieldVal += atmScreens[activeScreenUID].code.split(",")[x];
                    CodeFieldVal += "\n";
                    $("#CodeField").val(CodeFieldVal);
                }

                $('.canvasContainer').css('background-image', 'url("' + atmScreens[activeScreenUID].url + '")');

            });

            $(document).on("click", function (e) {
                if (!$(e.target).hasClass("genericContextMenu")) {
                    $(".genericContextMenu").hide();
                }
            });

            $(document).on("contextmenu", ".atmScreen.editableScreen", function (e) {
                e.preventDefault();
                if (!$(e.target).hasClass("active")) {
                    rightClickedScreen = $(e.target).attr("uid");
                    $(".atmScreensContextMenu").css("left", $(e.target).position().left + 72).show();
                }
            });

            $(document).on("contextmenu", ".atmBtn", function (e) {
                e.preventDefault();
                var posL = $(e.currentTarget).position().left + 110;
                var posT = $(e.currentTarget).position().top + 21;

                if ($(e.currentTarget).hasClass("btnRight")) {
                    posL = $(e.currentTarget).position().left - 121;
                }

                $(".atmButtonsContextMenu").css({
                    "left": posL,
                    "top": posT,
                }).show();

                atmBtnID = $(e.currentTarget).attr("btnid");

            });

            $(document).on("click", ".atmButtonsContextMenu .btnAction", function (e) {
                atmScreens[activeScreenUID].buttons[atmBtnID] = $(e.currentTarget).attr("lbl");
                $(".genericContextMenu").hide();
                //drawAll();
            });

            //var newScreenID = "atmSC" + new Date().getTime();
            //$(".imgThumbnail").attr("id", newScreenID);
            //$(".atmScreen.active").eq(0).attr("uid", newScreenID);

            //activeScreenUID = newScreenID;
            //atmScreens[activeScreenUID] = {
            //    url: "",
            //    rect: {},
            //    buttons: { "b1": "N/A", "b2": "N/A", "b3": "N/A", "b4": "N/A", "b5": "N/A", "b6": "N/A", "b7": "N/A", "b8": "N/A" },
            //    filename: "",
            //    code: "",
            //    isImageUploaded: ""
            //}

            GetAllImagesList();
            //drawAll();

            $.get("./RawData/o2screens.txt", function (response) {
                var ind = 0;
                for (var x = 0; x < response.split("\n").length; x++) {
                    if (response.split("\n")[x].trim() == "FS") {
                        ind = 0;
                        DummyObj.push(tempObj);
                        tempObj = {};
                    } else {
                        tempObj[ind] = response.split("\n")[x].trim();
                        ind += 1;
                    }
                }

                //console.log(DummyObj);

                var SanitizedData = [];
                var FinalObj = [];


                for (var y = 0; y < DummyObj.length; y++) {
                    for (key in DummyObj[y]) {
                        //console.log(key);
                        if (!DummyObj[y][key].includes("SCREENS") && !DummyObj[y][key].includes("{         ") && !DummyObj[y][key].includes("{{") && !DummyObj[y][key].includes("{ ")) {
                            if (DummyObj[y][key] != "" && DummyObj[y][key] != " " && DummyObj[y][key].substring(0, 1) != "{") {
                                //console.log(DummyObj[y][key]);
                                SanitizedData.push(DummyObj[y][key].replace("             {SCREEN NUMBER", ""));
                            }
                        }
                    }
                    SanitizedData.push("FS");
                }

                var TempObj = [];
                var Counter = 0;

                for (var z = 0; z < SanitizedData.length; z++) {
                    if (SanitizedData[z] != "FS") {
                        TempObj[Counter] += SanitizedData[z];
                        TempObj[Counter] += "\n";
                    }
                    if (SanitizedData[z] == "FS") {
                        Counter++;
                    }
                }

                $('.ui-sortable').html("");

                for (var w = 0; w < TempObj.length; w++) {
                    var TempVar = TempObj[w].replace("undefined", "").split("\n");
                    RenderDynamicScreens(TempVar, w);
                }

                setTimeout(function () {
                    $(".editableScreen").first().trigger("click");
                }, 500)

            })

        });

        function onClick_RemoveScreen() {
            if (confirm("This action remove the screen from the set. Are you sure to continue?")) {
                for (var item in atmScreens) {
                    if (item == rightClickedScreen) {
                        delete atmScreens[item];
                    }
                }
                $(".atmScreensContextMenu").hide();
                $(".atmScreen[uid='" + rightClickedScreen + "']").remove();
                //drawAll();
            }
        }

        function onAddCursorPoint() {

            var Row = $("#CursorRow").val();
            var Column = $("#CursorColumn").val();
            var CodeFieldVal = $("#CodeField").val();
            CodeFieldVal += "\n";
            CodeFieldVal += "SET " + Row + Column;
            $("#CodeField").val(CodeFieldVal);
            $('#CursorModal').modal('hide');

        }

        function GetLastLine() {
            var content = $("#CodeField").val();
            var lastLine = content.substr(content.lastIndexOf("\n") + 1);
            return lastLine;
        }

        function GetCursorPoint(LastLine) {
            var str = LastLine;
            var after = str.substring(str.indexOf(' ') + 1);
            var Coordinates = after.split("");
            return Coordinates;
        }

        function RenderTextParam(Text, X_Position, Y_Position) {
            var Xaxis = X_Position;
            var text = Text
            var myArray = text.split("");
            for (var i = 0; i < myArray.length; i++) {
                ctx.font = "26px Arial";
                ctx.fillText(myArray[i], Xaxis, Y_Position);
                Xaxis = Xaxis + 20;
            }
        }

        function onAddImageText() {
            var CodeFieldVal = $("#CodeField").val();
            var ImageID = $("#ImgID").val();
            CodeFieldVal += "\n";
            CodeFieldVal += "ESC P2 " + ImageID.substring(1, 3) + " ESC";
            $("#CodeField").val(CodeFieldVal);
            $('#ImagesModal').modal('hide');
            $('.canvasContainer, .atmScreen.active').css('background-image', 'url("' + $("#ImgSrc").val() + '")');

            atmScreens[activeScreenUID].url = $("#ImgSrc").val();
            atmScreens[activeScreenUID].filename = $("#ImgID").val();
            atmScreens[activeScreenUID].isImageUploaded = "1";

        }

        function onAddText(data) {
            var Text = $("#TextField").val();
            var LastLine = GetLastLine()
            var Coordinates = GetCursorPoint(LastLine);
            var CodeFieldVal = $("#CodeField").val();
            RenderTextParam(Text, CoordinateMapX[Coordinates[0]], CoordinateMapY[Coordinates[1]])
            Text = Text.replace(/ /g, "~");
            CodeFieldVal += "\n";
            CodeFieldVal += Text;
            $("#CodeField").val(CodeFieldVal);
            $('#TextModal').modal('hide');
        }

        function GetAllImagesList() {
            $(".owl-carousel").html("");
            var dir = "img/";
            var fileextension = ".jpg";
            $.ajax({
                //This will retrieve the contents of the folder if the folder is configured as 'browsable'
                url: dir,
                success: function (data) {
                    //List all .png file names in the page
                    $(data).find("a:contains(" + fileextension + ")").each(function () {

                        var filename = this.href.replace(window.location.host, "").replace("http://", "");
                        var n = filename.lastIndexOf('/');
                        var TrimmedFileName = filename.substring(n + 1);
                        var tempURL = "http://localhost:81";

                        //$(".owl-carousel").append("<div><a target='_blank' href='"+ tempURL + filename + "'>" +
                        $(".owl-carousel").append("<div><div class='ATMImg' onclick='OnClickSelectImage(event)' uid=" + TrimmedFileName + ">" +
                            "<img src='" + tempURL + filename + "'style='width:150px'></a>" +
                            "<label>" + TrimmedFileName + "</label>" +
                            "</div>");


                    });
                    $('.owl-carousel').owlCarousel({
                        margin: 10,
                        nav: false,
                        responsive: {
                            0: {
                                items: 3
                            },
                            600: {
                                items: 3
                            },
                            1000: {
                                items: 3
                            }
                        }
                    })
                }
            });
        }

        function OnClickSelectImage(event) {

            $("#ImgID").val($(event.target).parent().attr("uid"));
            $("#ImgSrc").val($(event.target).attr("src"));

            $(".ATMImg").removeClass("ActiveImg");
            $(event.target).parent().addClass("ActiveImg");

                            }

        function RenderDynamicScreens(data, index) {

            var FirstIndex = data[0];
            FirstIndex = $.trim(FirstIndex);

            var newScreenID = "atmSC" + FirstIndex + index;

            atmScreens[newScreenID] = {
                url: "",
                rect: {},
                buttons: { "b1": "N/A", "b2": "N/A", "b3": "N/A", "b4": "N/A", "b5": "N/A", "b6": "N/A", "b7": "N/A", "b8": "N/A" },
                filename: "",
                code: data.join(","),
                isImageUploaded: ""
            }

            $('.ui-sortable').append("<div uid=" + newScreenID + " class='atmScreen editableScreen'>Screen " + index+"</div>");


        }

        var CoordinateMapX = {
            "@": 0,
            "A": 20,
            "B": 40,
            "C": 60,
            "D": 80,
            "E": 100,
            "F": 120,
            "G": 140,
            "H": 160,
            "I": 180,
            "J": 200,
            "K": 220,
            "L": 240,
            "M": 260,
            "N": 280,
            "O": 300,
            "0": 320,
            "1": 340,
            "2": 360,
            "3": 380,
            "4": 400,
            "5": 420,
            "6": 440,
            "7": 460,
            "8": 480,
            "9": 500,
            ":": 520,
            ";": 540,
            "<": 560,
            "=": 580,
            ">": 600,
            "?": 620,
        }

        var CoordinateMapY = {
            "@": 0,
            "A": 26,
            "B": 52,
            "C": 78,
            "D": 104,
            "E": 130,
            "F": 156,
            "G": 182,
            "H": 208,
            "I": 234,
            "J": 260,
            "K": 286,
            "L": 312,
            "M": 338,
            "N": 364,
            "O": 390
        }

    </script>
</body>
</html>
